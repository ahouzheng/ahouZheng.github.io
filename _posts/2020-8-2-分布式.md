---
title: 分布式
auther: ahou
layout: post
description: 分布式相关知识
categories: general
---

## CAP理论
CAP理论是分布式系统的基础，分别是指一致性(Consistensy)，可用性(Availability)和分区容错性(Partition tolerance)，它们的含义是：  
- 一致性，分布式系统的多个节点数据保持一致  
- 可用性，系统能够在正常的时间内对请求做正确的响应  
- 分区容错性，当某个节点或分区发生故障时，系统仍然能够提供服务  

**CAP理论指出：分布式系统最多只能满足CAP中的两项**  
例如，当系统中节点A向节点B的网络发生故障，在保证分区容错的条件下，系统能够提供服务，但此时若访问A节点修改了数据x，由于网络故障无法及时的同步到B，那么如果要保证**一致性**，执行等待故障修复后B才能响应数据x的请求，违反可用性，如果要保证**可用性**，只能返回未同步的数据x，违反一致性。  

由于CAP理论提出的限制，分布式系统必须在CAP之中选择两个，但分区容错性P是分布式系统的根本，一般不能违背，所以分布式系统多实现了CP和AP  
对数据一致性要求严格的场合，选择CP，放弃一些情况下的可用性。  
对于一致性要求不那么高的场合，选择AP来保证可用性，但这时放弃的是强一致性(时刻一致)，可能是弱一致性或最终一致性。  


## 分布式事务

**参考文章：[article1](https://www.cnblogs.com/mayundalao/p/11798502.html)，[article2](https://baijiahao.baidu.com/s?id=1634759073848664238&wfr=spider&for=pc)**  

#### 介绍
分布式事务是指一个任务分解到多个节点上执行，如何保证它的提交与回滚操作，使它具有ACID的事务属性

#### 两阶段提交协议2PC
两阶段提交中，引入协调者来协调多个参与者的任务执行，来达到任务的事务属性  

- 准备阶段  
    协调者向参与者发送任务，参与者执行并返回执行结果，此时不执行commit操作
- 提交阶段  
    当准备阶段所有参与者都返回成功执行，协调者发送提交命令，参与者执行commit操作，否则回滚

**缺点：**  
- 同步阻塞问题，等待其他参与者响应过程中，所有参与者都处在同步阻塞中，无法执行其他操作
- 协调者向参与者发送commit命令时，如果由于网络问题导致有些参与者没有及时收到commit，会出现不一致问题
- 协调者的单点问题，协调者故障，整个执行都出现问题，特别是提交阶段，所有参与者都需等待

#### TCC
**参考文章：[TCC举例详细介绍](https://www.cnblogs.com/jajian/p/10014145.html)**  
补偿事务  
TCC分布式事务的执行分为三个阶段：
- **Try** 尝试执行事务，预留需要的资源  
    比如商品库存扣减中，添加一个预扣减字段，try阶段写该字段，如果写入成功，表明资源访问正常，
有理由相信真正的扣减操作也是大概率成功的
- **confirm** 当try阶段全部执行成功后，执行该操作，进行实际的业务操作  
    此时进行真正的业务操作，从商品库存中减去预扣减的值，将预扣减置零  
- **cancel** 当try阶段执行出错时，cancel之前的操作，将预留的资源释放掉  
    将预扣减的字段置零  

TCC分布式事务框架会保存活动日志，当出现出现机器宕机时，根据日志记录重新执行confirm
或者cancel操作，重试直到成功  

**优缺点：**
- 流程简单
- confirm和cancel都可能失败
- TCC位于应用层，需要配合实现业务处理，使用该方案就要实现Try阶段预留资源，confirm提交等逻辑，
    业务未必适合这种形式  
    
    
## 分布式系统一致性