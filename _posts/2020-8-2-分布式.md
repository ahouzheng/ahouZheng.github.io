---
title: 分布式
auther: ahou
layout: post
description: 分布式相关知识
categories: general
---


## 分布式事务

**参考文章：[article](https://www.cnblogs.com/mayundalao/p/11798502.html)**  

#### 介绍
分布式事务是指一个任务分解到多个节点上执行，如何保证它的提交与回滚操作，使它具有ACID的事务属性

#### 两阶段提交协议2PC
两阶段提交中，引入协调者来协调多个参与者的任务执行，来达到任务的事务属性  

- 准备阶段  
    协调者向参与者发送任务，参与者执行并返回执行结果，此时不执行commit操作
- 提交阶段  
    当准备阶段所有参与者都返回成功执行，协调者发送提交命令，参与者执行commit操作，否则回滚

**缺点：**  
- 同步阻塞问题，等待其他参与者响应过程中，所有参与者都处在同步阻塞中，无法执行其他操作
- 协调者向参与者发送commit命令时，如果由于网络问题导致有些参与者没有及时收到commit，会出现不一致问题
- 协调者的单点问题，协调者故障，整个执行都出现问题，特别是提交阶段，所有参与者都需等待

#### TCC
**参考文章：[TCC举例详细介绍](https://www.cnblogs.com/jajian/p/10014145.html)**  
补偿事务  
TCC分布式事务的执行分为三个阶段：
- **Try** 尝试执行事务，预留需要的资源  
    比如商品库存扣减中，添加一个预扣减字段，try阶段写该字段，如果写入成功，表明资源访问正常，
有理由相信真正的扣减操作也是大概率成功的
- **confirm** 当try阶段全部执行成功后，执行该操作，进行实际的业务操作  
    此时进行真正的业务操作，从商品库存中减去预扣减的值，将预扣减置零  
- **cancel** 当try阶段执行出错时，cancel之前的操作，将预留的资源释放掉  
    将预扣减的字段置零  

TCC分布式事务框架会保存活动日志，当出现出现机器宕机时，根据日志记录重新执行confirm
或者cancel操作，重试直到成功  

**优缺点：**
- 流程简单
- confirm和cancel都可能失败
- TCC位于应用层，需要配合实现业务处理，使用该方案就要实现Try阶段预留资源，confirm提交等逻辑，
    业务未必适合这种形式  